<!--Java Scrips functions-->
<script>
  function edit_button(buttonId)
  { 
    var remove_list = ["status", "note", "btnSave"];
    var set_list = ["statusT", "noteT", "btn"];

    for (var i = 0; i < remove_list.length; i++)
    {
      document.getElementById(remove_list[i]+ buttonId[3]).removeAttribute("hidden");
      document.getElementById(set_list[i]+ buttonId[3]).setAttribute("hidden","true");
    }
    
  }

  function save_button(buttonId)
  { 
    var info = {};
    info.row = buttonId[7];
    if ( document.getElementById("status"+ buttonId[7]).value == "no_selec")
    {
      info.status = document.getElementById("statusT"+ buttonId[7]).innerHTML;
    }
    else
    {
      info.status = document.getElementById("status"+ buttonId[7]).value;
    }
    
    info.note = document.getElementById("note"+ buttonId[7]).value;

    var remove_list = ["statusT", "noteT", "btn"];
    var set_list = ["status", "note", "btnSave"]; 

    for (var i = 0; i < remove_list.length; i++)
    {
      document.getElementById(remove_list[i]+ buttonId[7]).removeAttribute("hidden");
      document.getElementById(set_list[i]+ buttonId[7]).setAttribute("hidden","true");
    }

    document.getElementById("statusT"+ buttonId[7]).innerHTML = info.status;
    document.getElementById("noteT"+ buttonId[7]).innerHTML = info.note;
    
    google.script.run.saveUser(info); 
  }

  function booking(buttonId)
  {
    var d = new Date();
    var day = parseInt(d.getDate());
    var month = parseInt(d.getMonth()+1);

    day = (day<10) ? "0"+(day).toString() : (day).toString();
    month = (month<10) ? "0"+(month).toString() : (month+1).toString();
    date_string = d.getFullYear()+"-"+month+"-"+day;
    document.getElementById("Date"+ buttonId[10]).setAttribute("min",date_string);
    document.getElementById("Date"+ buttonId[10]).setAttribute("value",date_string);

    // document.getElementById("DisplayB"+ buttonId[10]).setAttribute("hidden","true");
    document.getElementById("deleteBooking"+ buttonId[10]).setAttribute("hidden","true");
    document.getElementById("calendar"+ buttonId[10]).removeAttribute("hidden");
    document.getElementById("buttonBook"+ buttonId[10]).setAttribute("hidden","true");
    document.getElementById("calendarT"+ buttonId[10]).setAttribute("hidden",'true');
  }

  function save_booking(buttonId)
  {
    var current_time = new Date();
    var bookingInfo = {};
    document.getElementById("calendar"+ buttonId[11]).setAttribute("hidden","true");
    
    bookingInfo.row = buttonId[11];
    bookingInfo.name = document.getElementById("name"+ buttonId[11]).innerHTML;

    bookingInfo.date = document.getElementById("Date"+ buttonId[11]).value;
    bookingInfo.startTime = document.getElementById("StartTime"+ buttonId[11]).value;
    bookingInfo.finishTime = document.getElementById("FinishTime"+ buttonId[11]).value;
    var s_time = new Date(bookingInfo.date.toString()+" "+bookingInfo.startTime.toString()); 

    if (bookingInfo.startTime>bookingInfo.finishTime) 
    {
      document.getElementById("calendarT"+ buttonId[11]).removeAttribute("hidden");
      document.getElementById("buttonBook"+ buttonId[11]).removeAttribute("hidden");
      document.getElementById("calendarT"+ buttonId[11]).innerHTML = "終了時刻は開始時刻より早くできません";
      return;
    }
    else if (s_time<current_time)
    {
      document.getElementById("calendarT"+ buttonId[11]).removeAttribute("hidden");
      document.getElementById("buttonBook"+ buttonId[11]).removeAttribute("hidden");
      document.getElementById("calendarT"+ buttonId[11]).innerHTML = "開始時刻を現在の時刻より早くできません "+s_time;
      return; 
    }
    
    document.getElementById("Loader"+ buttonId[11]).removeAttribute("hidden");
    bookingInfo.finalDate=bookingInfo.date + " " + bookingInfo.startTime + " - " + bookingInfo.finishTime;    

    google.script.run
    .withSuccessHandler((flag_exist)=>{
      if (flag_exist) // no reservation exists
      {
        // document.getElementById("calendarT"+ buttonId[11]).innerHTML =bookingInfo.finalDate;
        // document.getElementById("deleteBooking"+ buttonId[11]).removeAttribute("hidden");
        document.getElementById("buttonBook"+ buttonId[11]).removeAttribute("hidden");
        // document.getElementById("DisplayB"+ buttonId[11]).removeAttribute("hidden");
        document.getElementById("Loader"+ buttonId[11]).setAttribute("hidden","true");
        document.getElementById("calendarT"+ buttonId[11]).setAttribute("hidden","true");
      }
      else// reservation exists
      {
        document.getElementById("calendarT"+ buttonId[11]).removeAttribute("hidden");
        document.getElementById("calendarT"+ buttonId[11]).innerHTML = "予約時間ご利用いただけません";
        document.getElementById("buttonBook"+ buttonId[11]).removeAttribute("hidden");
        document.getElementById("Loader"+ buttonId[11]).setAttribute("hidden","true");
        // alert("Booking time: Unavailable");
      }
      display_booking(buttonId[11]);
    })
    .withFailureHandler((e)=>{
      document.getElementById("calendarT"+ buttonId[11]).innerHTML = "予約時間ご利用いただけません";
      document.getElementById("buttonBook"+ buttonId[11]).removeAttribute("hidden");
    })
    .saveBooking(bookingInfo);
    
  }

  function delete_booking(buttonId)
  { 
    var close = document.getElementsByClassName("close");
    var delete_items = {};
    delete_items.row = buttonId[13];
    delete_items.list = [];
    var index = 0;
    
    for (var i = 0 ; i<close.length ; i++)
    {
      var id_item = "li"+(i+1).toString();
      if (document.getElementById(id_item).classList == "checked")
      {
        delete_items.list[index] = i+1;
        index ++ ;
      }
    } 
    
    if (delete_items.list.length == 0)
    {
      alert("削除予約なし")
      return;
    }

    document.getElementById("calendarT"+ buttonId[13]).setAttribute("hidden","true");
    document.getElementById("deleteBooking"+ buttonId[13]).setAttribute("hidden","true");
    document.getElementById("buttonBook"+ buttonId[13]).setAttribute("hidden","true");
    document.getElementById("List"+ buttonId[13]).setAttribute("hidden","true");

    document.getElementById("Loader"+ buttonId[13]).removeAttribute("hidden");
    
    google.script.run.withSuccessHandler(()=>{
      document.getElementById("Loader"+ buttonId[13]).setAttribute("hidden","true");
      document.getElementById("buttonBook"+ buttonId[13]).removeAttribute("hidden");
      // document.getElementById("DisplayB"+ buttonId[13]).removeAttribute("hidden");

      display_booking(buttonId[13]);
    }
    ).deleteBooking(delete_items);
  }

  function cancel_booking(buttonId)
  {
    document.getElementById("buttonBook"+ buttonId[13]).removeAttribute("hidden");
    document.getElementById("calendar"+ buttonId[13]).setAttribute("hidden","true");
    document.getElementById("deleteBooking"+ buttonId[13]).setAttribute("hidden","true");
    // document.getElementById("cancelBooking"+ buttonId[13]).setAttribute("hidden","true");
    document.getElementById("DisplayB"+ buttonId[13]).removeAttribute("hidden");
  }

  function cancel_display(buttonId) // 戻るボタン
  {
    document.getElementById("buttonBook"+ buttonId[13]).removeAttribute("hidden");
    document.getElementById("DisplayB"+ buttonId[13]).removeAttribute("hidden");

    document.getElementById("deleteBooking"+ buttonId[13]).setAttribute("hidden","true");
    document.getElementById("List"+ buttonId[13]).setAttribute("hidden","true");
    document.getElementById("cancelDisplay"+ buttonId[13]).setAttribute("hidden","true");
    document.getElementById("calendarT"+ buttonId[13]).setAttribute("hidden","true");
  }

  function display_booking(userId)
  {
    //alert(userId)
    userId = userId.toString();
    document.getElementById("buttonBook"+ userId).setAttribute("hidden","true");
    //　document.getElementById("DisplayB"+ userId).setAttribute("hidden","true");
    document.getElementById("Loader"+ userId).removeAttribute("hidden");

    google.script.run.withSuccessHandler((listBooking)=>
    {
      document.getElementById("Loader"+ userId).setAttribute("hidden","true");
      // document.getElementById("cancelDisplay"+ userId).removeAttribute("hidden");
      document.getElementById("List"+ userId).removeAttribute("hidden");
      document.getElementById("deleteBooking"+ userId).removeAttribute("hidden");
      document.getElementById("buttonBook"+ userId).removeAttribute("hidden");
  
      if (listBooking[1]=="")
      {
        document.getElementById("calendarT"+ userId).removeAttribute("hidden");
        document.getElementById("List"+ userId).setAttribute("hidden","true");
        document.getElementById("calendarT"+ userId).innerHTML = "予約はありません";
        return;
      }
      
      var name_list = 'List'+listBooking[0];
      var list = document.getElementById(name_list);
      document.getElementById(name_list).innerHTML = "";

      if (parseInt(listBooking[0])%2 == 0)
      {
        document.getElementById(name_list).setAttribute("class","blue");
      }
      else
      {
        document.getElementById(name_list).setAttribute("class","white");
      }

      for (var i = 1; i < listBooking.length; i++) 
      {
        var node = document.createElement("LI");
        var textnode = document.createTextNode(listBooking[i]);
        node.appendChild(textnode);
        node.setAttribute("id","li"+(i).toString());
        // node.classList.add("checked");
        document.getElementById(name_list).appendChild(node);
        
      }
      create_close_button();
    }
    ).read_booking_active_user(userId);
  }

  // Create a "close" button and append it to each list item
  function create_close_button()
  {
    var myNodelist = document.getElementsByTagName("LI");
    var i;
    for (i = 0; i < myNodelist.length; i++) 
    {
      var span = document.createElement("SPAN");
      var txt = document.createTextNode("\u00D7");
      
      span.className = "close";
      span.setAttribute("id","b"+(i+1).toString());
      span.appendChild(txt);
      myNodelist[i].appendChild(span);
    }
    close_button();
  }

  // Click on [×] button to select the item to delete
  function close_button()
  {
    var close = document.getElementsByClassName("close");
    for (var i = 0; i < close.length; i++) 
    { 
      close[i].onclick = function() 
      {
        var id_item = "li"+this.id[1];
        var item = document.getElementById(id_item);
        // alert(item.classList)
        item.classList.toggle("checked");
      }
    }
  } 

  // This function is called after the page is loaded
  window.onload = function() {
    userId = document.getElementById("userId").innerHTML;
    // alert(userId);
    display_booking(userId);
    reLoad();
  };

  function reLoad() 
  {
    setTimeout( function() 
    {
      google.script.run
      .withSuccessHandler(function(url)
      {
        window.open(url,'_top');
      }).getScriptURL();
    }, 1000*60*5); // 1000 ms * (60 seconds) * (desired minutes)
  } 
  
  // This functions makes the popup appear
  function popup()
  {
    var modal = document.getElementById("myModal");
    modal.style.display = "block";
    popup_close();
  }

  function popup_close()
  {
    var span = document.getElementsByClassName("close_popup")[0];
    var modal = document.getElementById("myModal");

    span.onclick = function() 
    {
      modal.style.display = "none";
    }
  }

  function send_message()
  {
    var msg = {};
    msg.email = document.getElementById("msg_email").value;
    msg.memo = document.getElementById("memo").value;
    google.script.run.withSuccessHandler(()=>
    {
      var modal = document.getElementById("myModal");
      modal.style.display = "none";
    }
    ).sendMessage(msg);
  }
</script>